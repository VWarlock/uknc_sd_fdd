---
layout: post
title: "Описание устройства"
comments: false
---
  
#Аппаратная часть.  
&nbsp;&nbsp;&nbsp;&nbsp;
Устройство разработано на основе микросхемы серии
PSoC4 от cypress - CY8C4245AXI-483, которая кроме обычного микроконтроллера
на основе ARM Cortex-M0, содержит весьма необычные программируемые цифровые
блоки UDB, а также программно коммутируемые аналоговые блоки. Цифровые блоки - это
не программная эмуляция логических элементов на микроконтроллере, а полноценные цифровые
блоки программно коммутируемые с внешними выводами, между собой и с микроконтроллером, как
маленькая ПЛИС. 
&nbsp;&nbsp;&nbsp;&nbsp;Шина МПИ, используемая
в УКНЦ, имеет совмещенные линии адреса и данных, что требует наличие регистра
хранения адреса в устройстве. Использование блоков UDB для защелкивания и
проверки диапазона адреса, обеспечивает достаточную скорость для взаимодействия
устройства с УКНЦ по шине.  
![Конфигурация ]({{site.baseurl}}/images/psoc_udb_config.png)<br>
<font size=-2><i>Схема конфигурации цифровых блоков в программе PSoC Creator</i></font>

&nbsp;&nbsp;&nbsp;&nbsp;
Поступающий с шины адрес инвертируется и сохраняется в регистре адреса,
представленном на схеме в виде пары 8-разрядных D-трипперов. Защелкивание происходит
по сигналу СИА. Далее с помощью логических элементов происходит определение принадлежность
захваченного адреса устройству, проверка выбора нужного банка нужной кассеты ПЗУ, определение
вида операции и поддиапозона, которому принадлежит адрес. Результат этих проверок
читается микроконтроллером через регистр STATE:

* 0-й разряд - чтение по адресу 0100000-0115776 
* 1-й разряд - чтение по адресу 0116000-0117776
* 2-й разряд - запись по адресу 0116000-0117776

&nbsp;&nbsp;&nbsp;&nbsp;
Разряды регистра STATE устанавливаются только если выбран первый банк кассеты ПЗУ.  
&nbsp;&nbsp;&nbsp;&nbsp;
При ненулевом значении этого регистра, микроконтроллер читает или устанавливает значение на шине и
формирует СИП согласно протоколу МПИ.  
&nbsp;&nbsp;&nbsp;&nbsp;
Также к PSoC4 подключена SD-карта, работающая по протоколу SPI. Функционирование SPI
осуществляется через блок последовательного интерфейса, который, в отличие от UDB,
жестко привязан к порту 4 микросхемы. SD-карта питается от 3.3 вольта, для понижения
напряжения используется стабилизатор с низким падением напряжения, например белорусский
K1235ЕН3БП или LM2931AZ. Выводы SD-карты защищены от перенапряжения (не очень хорошо, правда).

&nbsp;&nbsp;&nbsp;&nbsp;
Все сигналы могут быть переназначены на различные выводы PSoC4, кроме порта 4. В прототипе
используется следующая конфигурация.

![Конфигурация выводов]({{site.baseurl}}/images/psoc_pin_config.png)<br>
<font size=-2><i>Схема конфигурации выводов в PSoC Creator</i></font>

&nbsp;&nbsp;&nbsp;&nbsp;
Устройство тактируется от внутреннего RC-генератора на частоте 48МГц, стабильность не нужна.

#Управляющая программа в PSoC.

&nbsp;&nbsp;&nbsp;&nbsp;
Основной цикл программы непрерывно читает регистр STATE и в случае появления в одном
из разрядов единицы, осуществляет следующие действия:

* При чтении по адресам 0100000-0115776 произходит выдача слова из массива расположенного
во флэш-памяти PSoC4. Таким образом на эти адреса отображается "прошивка" устройства,
содержащая начальный загрузчик кассеты ПЗУ и драйвер. Линия БАЙТ работает только с этим диапазоном
но не используется программой в УКНЦ (сделано для отладочных целей).
* При чтении или записи по адресам 0116000-0117776 происходит чтение или запись в
буфер ОЗУ PSoC, т.е. на эти адреса отображается 1Кбайт памяти.
* При записи в адрес 0117776 происходит выполнение команды, код которой передан в
записываемом слове. Параметры команды передаются через буфер 0116000-0117774.

&nbsp;&nbsp;&nbsp;&nbsp;
При выполнении данных действий, устройство формирует сигнал подтверждения СИП. Однако,
в программе не использовались прерывания и при выполнении команд микроконтроллер
перестает обслуживать шину МПИ, если в этот момент произойдет обращение УКНЦ по
адресам устройства - произойдет зависание по вектору 4. Чтобы этого избежать используется
линия ИНДЕКС. При выполнении команды, после формирования СИП, на данную линию выставляется
единица, а после завершения выполнения сбрасывается в ноль и процессор в PSoC возвращается
к обслуживанию шины МПИ. Таким образо, перефирийный процессор УКНЦ после запуска
команды (запись в 0117776) должен читать значение с линии ИНДЕКС и ожидать готовности.
Сигнал управления светодиодом LED повторяет значение ИНДЕКС.  

{% highlight c %}

    for(;;)
    {
        st=STATE_Read();
        while(st==7) st=STATE_Read();
        if(st>=4)
        {
            AD_H_SetDriveMode(AD_H_DM_STRONG);
            AD_L_SetDriveMode(AD_L_DM_STRONG);
      
            if(st==5)
            {
                adr=AL_reg_Read()+(AH_reg_Read()<<8)-0116000;
                AD_L_Write(~buf[adr]);
                AD_H_Write(~buf[adr+1]);
            }
            else
            {
                adr=(AL_reg_Read()+(AH_reg_Read()<<8)-0100000);
                if(BYTE_Read()) AD_H_Write(~rom[adr+1]); else AD_H_Write(0);
                AD_L_Write(~rom[adr]);
            }
            SIP_Write(0);
            st=STATE_Read();
            while(st!=7) st=STATE_Read();
        
            AD_H_SetDriveMode(AD_H_DM_DIG_HIZ);
            AD_L_SetDriveMode(AD_L_DM_DIG_HIZ);
            SIP_Write(1);
        }
        else
        {
            adr=AL_reg_Read()+(AH_reg_Read()<<8)-0116000;
            buf[adr]=~AD_L_Read();
            buf[adr+1]=~AD_H_Read();
            SIP_Write(0);
            st=STATE_Read();
            while(st!=7) st=STATE_Read();
            SIP_Write(1);
            if(adr==01776)
            {
                IDX_Write(1);
                LED1_Write(1);
                    execute_cmd(buf);
                IDX_Write(0);
                LED1_Write(0);
            }
        }
    }
}

{% endhighlight %}

