<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>УКНЦ контроллер SD-карты</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/syntax.css">>
</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">УКНЦ контроллер SD-карты</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Домой</a></li>
                    <li class="active visible-xs-block"><a href="/links.html">Ссылки</a></li>
                    <li class="active"><a href="/archive.html">Архив</a></li>
                    
                      <li class="active"><a href="https://github.com/y-salnikov/uknc_sd_fdd">Github</a></li>
                    
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container container-left">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
<b>Контроллер дисковода для УКНЦ(МС0511), который использует образы дисков на SD-карте.</b><br><br>
<font size=-1><i><b>Разработчик:</b> y.salnikov</i> </font>
</div>

<div class="sidebar well">
    <h1>Последние обновления</h1>
    <ul>
        
          <li><a href="/2015/09/description">Описание устройства</a></li>
        
          <li><a href="/2015/09/!doc_errors">Ошибки в документации к УКНЦ</a></li>
        
    </ul>
</div>

<div class="sidebar well">
<h1>Ссылки</h1>
<ul>
  <li><a href="http://felixl.com/Uknc_ROM_disasm">Листинг прошивки УКНЦ</a></li>
  <li><a href="http://we.easyelectronics.ru/electro-and-pc/poluchenie-sinhronnyh-dannyh-s-pomoschyu-mikroshemy-cypress-cy7c68013a-fx2lp-na-primere-ustroystva-videozahvata-dlya-staryh-kompyutorov.html">Статья про устройство видеозахвата на CY7C68013A</a></li>
</ul>

</div>

        </div>
        <div class="col-md-9">
            
<div class="article">
    <div class="well">
        <h1><a href="/2015/09/description">Sep 4, 2015 - Описание устройства</a></h1>
        
        <div class="content">
            <h1 id="Аппаратная-часть.">Аппаратная часть.</h1>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Схема электрическая принципиальная:<br>
<a href="https://github.com/y-salnikov/uknc_sd_fdd/blob/master/Hardware/uknc_sd_fdd_sch_.pdf?raw=true"><img src="/images/scheme.png" alt="Схема устройства"></a></p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Устройство разработано на основе микросхемы серии
PSoC4 от cypress - CY8C4245AXI-483, которая кроме обычного микроконтроллера
на основе ARM Cortex-M0, содержит весьма необычные программируемые цифровые
блоки UDB, а также программно коммутируемые аналоговые блоки. Цифровые блоки - это
не программная эмуляция логических элементов на микроконтроллере, а полноценные цифровые
блоки программно коммутируемые с внешними выводами, между собой и с микроконтроллером, как
маленькая ПЛИС.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Шина МПИ, используемая
в УКНЦ, имеет совмещенные линии адреса и данных, что требует наличие регистра
хранения адреса в устройстве. Использование блоков UDB для защелкивания и
проверки диапазона адреса, обеспечивает достаточную скорость для взаимодействия
устройства с УКНЦ по шине.<br>
<img src="/images/psoc_udb_config.png" alt="Конфигурация "><br>
<font size=-2><i>Схема конфигурации цифровых блоков в программе PSoC Creator</i></font></p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Поступающий с шины адрес инвертируется и сохраняется в регистре адреса,
представленном на схеме в виде пары 8-разрядных D-трипперов. Защелкивание происходит
по сигналу СИА. Далее с помощью логических элементов происходит определение принадлежность
захваченного адреса устройству, проверка выбора нужного банка нужной кассеты ПЗУ, определение
вида операции и поддиапозона, которому принадлежит адрес. Результат этих проверок
читается микроконтроллером через регистр STATE:</p>

<ul>
<li>0-й разряд - чтение по адресу 0100000-0115776 </li>
<li>1-й разряд - чтение по адресу 0116000-0117776</li>
<li>2-й разряд - запись по адресу 0116000-0117776</li>
</ul>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Разряды регистра STATE устанавливаются только если выбран первый банк кассеты ПЗУ.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
При ненулевом значении этого регистра, микроконтроллер читает или устанавливает значение на шине и
формирует СИП согласно протоколу МПИ.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Также к PSoC4 подключена SD-карта, работающая по протоколу SPI. Функционирование SPI
осуществляется через блок последовательного интерфейса, который, в отличие от UDB,
жестко привязан к порту 4 микросхемы. SD-карта питается от 3.3 вольта, для понижения
напряжения используется стабилизатор с низким падением напряжения, например белорусский
K1235ЕН3БП или LM2931AZ. Выводы SD-карты защищены от перенапряжения (не очень хорошо, правда).</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Все сигналы могут быть переназначены на различные выводы PSoC4, кроме порта 4. В прототипе
используется следующая конфигурация.</p>

<p><img src="/images/psoc_pin_config.png" alt="Конфигурация выводов"><br>
<font size=-2><i>Схема конфигурации выводов в PSoC Creator</i></font></p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Устройство тактируется от внутреннего RC-генератора на частоте 48МГц, стабильность не нужна.</p>

<h1 id="Управляющая-программа-в-psoc.">Управляющая программа в PSoC.</h1>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Основной цикл программы непрерывно читает регистр STATE и в случае появления в одном
из разрядов единицы, осуществляет следующие действия:</p>

<ul>
<li>При чтении по адресам 0100000-0115776 произходит выдача слова из массива расположенного
во флэш-памяти PSoC4. Таким образом на эти адреса отображается &quot;прошивка&quot; устройства,
содержащая начальный загрузчик кассеты ПЗУ и драйвер. Линия БАЙТ работает только с этим диапазоном
но не используется программой в УКНЦ (сделано для отладочных целей).</li>
<li>При чтении или записи по адресам 0116000-0117776 происходит чтение или запись в
буфер ОЗУ PSoC, т.е. на эти адреса отображается 1Кбайт памяти.</li>
<li>При записи в адрес 0117776 происходит выполнение команды, код которой передан в
записываемом слове. Параметры команды передаются через буфер 0116000-0117774.<br></li>
</ul>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
При выполнении данных действий, устройство формирует сигнал подтверждения СИП. Однако,
в программе не использовались прерывания и при выполнении команд микроконтроллер
перестает обслуживать шину МПИ, если в этот момент произойдет обращение УКНЦ по
адресам устройства - произойдет зависание по вектору 4. Чтобы этого избежать используется
линия ИНДЕКС. При выполнении команды, после формирования СИП, на данную линию выставляется
единица, а после завершения выполнения сбрасывается в ноль и процессор в PSoC возвращается
к обслуживанию шины МПИ. Таким образо, перефирийный процессор УКНЦ после запуска
команды (запись в 0117776) должен читать значение с линии ИНДЕКС и ожидать готовности.
Сигнал управления светодиодом LED повторяет значение ИНДЕКС.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Для работы с файловой системой на SD-карте используется библиотека 
<a href="http://elm-chan.org/fsw/ff/00index_e.html">FatFS от elm-chan</a>. Поддерживается как
обычные SD-карты, так и более новые SDHC. Карта должна содержать один раздел, отформатированный
в FAT. Образы дисков хранятся в каталоге disks, при этом файлы должны быть именованы
в формате 8.3, т.е. длина файла не должна превышать восьми символов, а расширение - трех.
Также не следует использовать кириллические имена файлов из-за несоответствия кодировок
в УКНЦ и DOS/Windows.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Устройство поддерживает 4 дисковода. Привязка виртуального дисковода к образу осуществляется
с помощью файла map.txt в корне SD-карты. Содержимое файла имеет следующий формат:  </p>

<div class="highlight"><pre><code class="language-text" data-lang="text">N:&lt;filename&gt;
Например:
1:image1.dsk
2:ImAgE2.DsK
3:games.dsk
4:empty.dsk</code></pre></div>
  

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Номер диска начинается с 1. Если какого-либо файла-образа нет, то он будет создан,
размер создаваемого образа определяется типом диска. Поддерживаются следующие типы дисков:  </p>

<ul>
<li>1 - Односторонний дисковод, размер образа 400Кб. Поддерживается родным ПО УКНЦ и RT-11,
но не используется по умолчанию.</li>
<li>2 - Двусторонний дисковод, размер образа 800Кб. Поддерживается родным ПО УКНЦ и RT-11,
и используется по умолчанию в нем.</li>
<li>3 - <s>Трехсторонний</s> Диск большой емкости, 256 дорожек, 255 секторов, 2 стороны. Размер
образа ~63Мб. Необходим драйвер для RT-11, есть низкоуровневая поддержка.<br></li>
</ul>

<h1 id="Программный-интерфейс-со-стороны-ПП-УКНЦ">Программный интерфейс со стороны ПП УКНЦ</h1>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Устройство использует адреса кассеты ПЗУ для взаимодействия с УКНЦ, таким образом,
для включения этих адресов в адресное пространство ПП, необходимо использовать регистр
управления адресным пространством 0177054. При этом отключается часть системного ПЗУ,
поэтому после завершения операции необходимо вернуть прежнее значение регистра.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Управление устройством происходит посредством комманд, посылаемых через буфер по адресам
0116000-0117777. Аргументы команды заносятся в буфер, затем происходит инициализация команды
посредством записи ее кода по адресу 117776. После инициализации команды, необходимо ожидать готовности, читая
значение на линии ИНДЕКС, при этом можно вновь подключить системное ПЗУ по адресу 0100000.
Буфер устройства поддерживает только операции со словами. </p>

<table><thead>
<tr>
<th style="text-align: center">Код команды</th>
<th>Аргументы.<br> Смещение в байтах<br>относительно адреса 116000</th>
<th>Описание команды</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center">0</td>
<td>нет</td>
<td><strong>Сброс.</strong> <br>     Выполняется инициализация обмена с SD-картой<br>и чтение файла map.txt</td>
</tr>
<tr>
<td style="text-align: center">1</td>
<td><b>вход:</b> <br> 2:тип диска 1..3<br>3:N_диска + сторона в старшем бите<br>4:дорожка <br>5:сектор <br><b>выход:</b><br>0:код ошибки или 0<br> 6,7:кол-во переданных БАЙТОВ<br> 8+:данные.</td>
<td><strong>Чтение сектора.</strong><br> Размер сектора фиксирован и равен 512 байт.</td>
</tr>
<tr>
<td style="text-align: center">2</td>
<td><b>вход:</b> <br> 2:тип диска 1..3<br>3:N_диска + сторона в старшем бите<br>4:дорожка <br>5:сектор<br> 8+:данные.  <br><b>выход:</b><br>0:код ошибки или 0<br> 6,7:кол-во переданных БАЙТОВ</td>
<td><strong>Запись сектора.</strong></td>
</tr>
<tr>
<td style="text-align: center">3</td>
<td><b>вход:</b> <br> 2:тип диска 1..3<br>3:N_диска + сторона в старшем бите<br>4:дорожка <br>6,7:код в зоне данных <br><b>выход:</b><br>0:код ошибки или 0<br></td>
<td><strong>Форматирование дорожки.</strong><br> Размер сектора фиксирован и равен 512 байт.</td>
</tr>
<tr>
<td style="text-align: center">4</td>
<td><b>вход:</b> <br> 2:кол-во слов для записи в лог<br>8+: данные</td>
<td><strong>Запись данныхв файл log.txt</strong><br>Данные записываются в восьмиричном виде. <br> Файл пересоздается при включении питания.<br>Перед каждой записью создается заголовок &quot;log entry:&quot;<br>Используется для отладки.</td>
</tr>
<tr>
<td style="text-align: center">5</td>
<td>нет</td>
<td><strong>Задержка в 1мС.</strong></td>
</tr>
<tr>
<td style="text-align: center">6</td>
<td><b>выход:</b> <br> 0,1: длина map-файла<br>2+: данные</td>
<td><strong>Чтение файла map.txt</strong><br>Размер файла не должен превышать 512 байт</td>
</tr>
<tr>
<td style="text-align: center">7</td>
<td><b>вход:</b> <br> 0,1: длина map-файла<br>2+: данные</td>
<td><strong>Запись файла map.txt</strong><br>Размер файла не должен превышать 512 байт</td>
</tr>
<tr>
<td style="text-align: center">8</td>
<td><b>вход:</b> <br> 0,1: N файла, с которого начинается чтение<br>2,3:кол-во файлов<br><b>выход:</b> <br> 0,1: кол-во байт прочитано<br>2,3: файлов всего<br>4+:имена файлов.</td>
<td><strong>Чтение каталога disks</strong><br> Данная команда не проверяет кол-во байт<br>нужно запрашивать не более 64 имен.<br>Имена могут иметь различную длину,<br>разделяются кодом 0</td>
</tr>
</tbody></table>

<h1 id="Процесс-загрузки-и-программный-интерфейс-со-стороны-ЦП-УКНЦ.">Процесс загрузки и программный интерфейс со стороны ЦП УКНЦ.</h1>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Работа устройства начинается, когда пользователь выбирает пункт загрузки с кассеты ПЗУ. Таким образом,
происходит загрузка первых 512 байт прошивки по адресу 0 и осуществляется запуск с этого адреса. Этот
начальный загрузчик загружает оставшуюся часть прошивки начиная с адреса 10000 и производит ее запуск.
После этого выявляется объем доступной для выделения памяти ПП, для этого выделяется весь доступный объем
памяти и сразу освобождается. Далее выделяется 2 куска памяти ПП, один свободный и освобождается, а второй
с необходимым размером в конце области памяти ПП. Это сделано для того, чтобы блок начиная с адреса 23666 был доступен
для любителей писать неперемещаемые программы в памяти ПП. В выделенный блок пересылается код драйвера и запускается.
После этого происходит загрузка первого сектора нулевой дорожки стандартными методами и его запуск с адреса 0, после
чего загружается операционная система обычным способом.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
В ОЗУ ПП, получив управление драйвер устанавливается как обработчик событий канала 2. После этого, все операции с устроиствами
типа 1,2 и 3 обрабатываются этим драйвером, а операции с другими типами устройств перенаправляются на старый обработчик в ПЗУ.
Таким образом происходит прозрачное для системы подключение дисков и операционная система загружается со стандартными драйверами
в пространстве ЦП.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Команды установки параметров дисковода, передаваемые через К2, игнорируются и сообщают об успешном завершении. Кроме стандартных
команд: чтение (10), запись (20) и форматирование (30); поддерживаются следующие команды:</p>

<table><thead>
<tr>
<th style="text-align: center">код команды</th>
<th style="text-align: right">массив параметров</th>
<th>описание</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center">101</td>
<td style="text-align: right">40400 <br>тип&nbsp;накопителя&nbsp;1..3<br>адрес&nbsp;ОЗУ&nbsp;ЦП<br> длина</td>
<td>Чтение файла привязки map.txt<br> после выполнения в поле &quot;длина&quot; возвращается кол-во прочитанных слов.</td>
</tr>
<tr>
<td style="text-align: center">102</td>
<td style="text-align: right">41000 <br>тип&nbsp;накопителя&nbsp;1..3<br>адрес&nbsp;ОЗУ&nbsp;ЦП<br> длина</td>
<td>Запись файла привязки map.txt</td>
</tr>
<tr>
<td style="text-align: center">103</td>
<td style="text-align: right">41400 <br>тип&nbsp;накопителя&nbsp;1..3<br>Номер&nbsp;начального&nbsp;файла <br>адрес&nbsp;ОЗУ&nbsp;ЦП<br>N&nbsp;файлов<br>длина</td>
<td>Чтение директории с файлами-образами.<br> Читаются имена N файлов начиная с начального файла. После выполнения в поле N файлов заносится общее кол-во файлов в каталоге, а в поле длина - кол-во слов.</td>
</tr>
</tbody></table>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
Для просмотра списка файлов-образрв и изменения привязки к виртуальным дискам, (не без помощи форумчан с zx-pk.ru) была разработана 
<a href="https://github.com/y-salnikov/uknc_sd_fdd/tree/master/PDP-11/rt-11">программа CHDISK под RT-11</a>. Параметры запуска:</p>

<ul>
<li>-L или --LIST для вывода списка файлов</li>
<li>-S или --SORT для вывода сортированного списка, работает медленно при большом количестве файлов. </li>
<li>N:filename.ext для привязки файла к диску N, где N от 0 до 3. Если файл не существует, то будет создан.</li>
</ul>

<p>Скриншот с загруженной RT-11 и результат выполнения команды CHDISK -L:
<img src="/images/video_capture_017.png" alt="Скриншот RT-11"></p>

<h1 id="Текущее-состояние">Текущее состояние</h1>

<p>&nbsp;&nbsp;&nbsp;&nbsp;
В ходе отладки устройства было замечено, что необходимо использовать задержку при выполнении дисковых операций, иначе происходит зависание во время
загрузки ОС. Причину такого поведения установить не удалось.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Также вместо линии ИНДЕКС использовался сигнал РЕЖ2, предназначенный для детектирования типа дисковода, но изменеие уровня воспринималось УКНЦ как нажатие
клавиши.<br>
&nbsp;&nbsp;&nbsp;&nbsp;
Весь код выложен на github, однако не уверен, что его хватит для сборки, скорее всего в PSoC Creator придется производить ручные настройки.
Для компиляции прошивки использовался мой <a href="https://github.com/y-salnikov/not-yet-assembler">недо-ассемблер</a>,
в котором вместо мнемоники используются коды команд.</p>

<p>Пришли платы. Заказывал на <a href="http://dirtyPCBs.com">http://dirtyPCBs.com</a> .</p>

<p><img src="/images/w_boards_only_.jpg" alt="Плата"></p>

<p>Собранный контроллер:
<img src="/images/board_complete_small.jpg" alt="Готовое устройство"></p>

        </div>
    </div>
</div>

<div class="article">
    <div class="well">
        <h1><a href="/2015/09/!doc_errors">Sep 4, 2015 - Ошибки в документации к УКНЦ</a></h1>
        
        <div class="content">
            <p>У меня было 3 источника: 2 разные схемы из интернета, и книга &quot; ЭВМ &#39;Электроника МС0511&#39; Техническое описание У11.700.016 ТО&quot;;, однако,
нигде не была указана правильная и полная распиновка разъемов ВУ1 и ВУ2. Назначение и расположение сигналов СЕ0-СЕ3 пришлось уточнять
с помощью логического анализатора. Полученное назначение выводов разъемов:<br>
<img src="/images/vu12.png" alt="Цоколевка ВУ1 и ВУ2"></p>

<p>Кроме того, в ТО в описании системного регистра управления ПП 177716 перепутаны значения разряда 3:</p>

<ul>
<li>0 - ИНДЕКС</li>
<li>1 - Магнитофон</li>
</ul>

<p>А сигнал РЕЖ2 читается через недокументированный регистр 177704.<br>
Я думаю, это ни для кого не секрет. Просто заметил, что документация не соответствует действительности.</p>

        </div>
    </div>
</div>


<div class="pagination">
  
  <span class="page_number ">Page: 1 of 1</span>
  
</div>

        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2015 УКНЦ контроллер SD-карты. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a></p>
        </div>
    </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'Jarik65535';

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>





</body>
</html>

